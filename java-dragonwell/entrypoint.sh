#!/bin/bash
set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
echo "üìÖ –î–∞—Ç–∞: $(date)"
echo "üîç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"
echo "üè† –î–æ–º–∞—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $HOME"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Java
echo "‚òï –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Java:"
java -version 2>&1 | head -3
echo ""

echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è libssl.so.3
if [ ! -f "/usr/lib/x86_64-linux-gnu/libssl.so.3" ] && [ ! -f "/lib/x86_64-linux-gnu/libssl.so.3" ]; then
    echo "‚ö†Ô∏è libssl.so.3 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å..."
    
    # –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å libssl3 (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ root)
    if command -v apt-get &> /dev/null && [ "$(id -u)" = "0" ]; then
        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ libssl3 —á–µ—Ä–µ–∑ apt..."
        apt-get update
        apt-get install -y --no-install-recommends libssl3 openssl
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        if [ -f "/usr/lib/x86_64-linux-gnu/libssl.so.3" ]; then
            echo "‚úÖ libssl.so.3 —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
        else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å libssl3. –ü—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏..."
            
            # –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤–µ—Ä—Å–∏–π libssl
            LIBSSL_PATH=$(find /usr -name "libssl.so*" 2>/dev/null | grep -v "Permission denied" | head -1)
            if [ -n "$LIBSSL_PATH" ]; then
                echo "üîç –ù–∞–π–¥–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞: $LIBSSL_PATH"
                LIB_DIR=$(dirname "$LIBSSL_PATH")
                ln -sf "$LIBSSL_PATH" "$LIB_DIR/libssl.so.3"
                ldconfig
                echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å–∏–º–≤–æ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è libssl.so.3"
            else
                echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ OpenSSL!"
                echo "üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker –æ–±—Ä–∞–∑ —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π libssl3 –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–∑"
                echo ""
                echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:"
                echo "–°–ø–∏—Å–æ–∫ SSL –±–∏–±–ª–∏–æ—Ç–µ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ:"
                find /usr -name "*ssl*" 2>/dev/null | grep -v "Permission denied" || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ"
                echo ""
                echo "–ü—É—Ç–∏ –ø–æ–∏—Å–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫:"
                echo $LD_LIBRARY_PATH
                echo ""
                echo "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã OpenSSL:"
                dpkg -l | grep ssl || echo "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
                exit 1
            fi
        fi
    else
        echo "üîí –ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫..."
        
        # –ü–æ–∏—Å–∫ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö libssl.so —Ñ–∞–π–ª–æ–≤
        echo "üîç –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö SSL –±–∏–±–ª–∏–æ—Ç–µ–∫..."
        FOUND_SSL_LIBS=()
        while IFS= read -r lib; do
            FOUND_SSL_LIBS+=("$lib")
            echo "   - $lib"
        done < <(find /usr /lib -name "libssl.so*" 2>/dev/null | grep -v "Permission denied")
        
        if [ ${#FOUND_SSL_LIBS[@]} -eq 0 ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã SSL –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–µ!"
            echo "üí° –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Docker –æ–±—Ä–∞–∑ —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π libssl3"
            echo "   –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –æ–±—Ä–∞–∑: ghcr.io/trenutoo/pterodactyl-images:java_21_dragonwell"
            exit 1
        fi
        
        echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã SSL –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å..."
        
        # –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ libssl.so.1.1 –∏ —Å–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
        for lib in "${FOUND_SSL_LIBS[@]}"; do
            if [[ "$lib" == *"libssl.so.1.1"* ]]; then
                echo "üîß –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ libssl.so.1.1, —Å–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏..."
                LIB_DIR=$(dirname "$lib")
                sudo ln -sf "$lib" "$LIB_DIR/libssl.so.3" 2>/dev/null || true
                sudo ln -sf "$(dirname "$lib")/libcrypto.so.1.1" "$(dirname "$lib")/libcrypto.so.3" 2>/dev/null || true
                sudo ldconfig 2>/dev/null || true
                echo "‚úÖ –°–æ–∑–¥–∞–Ω—ã —Å–∏–º–≤–æ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è libssl.so.3 –∏ libcrypto.so.3"
                break
            fi
        done
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if [ ! -f "/usr/lib/x86_64-linux-gnu/libssl.so.3" ] && [ ! -f "/lib/x86_64-linux-gnu/libssl.so.3" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è libssl.so.3"
            echo "üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ:"
            echo "   1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π –æ–±—Ä–∞–∑: ghcr.io/trenutoo/pterodactyl-images:java_21_dragonwell"
            echo "   2. –ò–ª–∏ –∑–∞–º–µ–Ω–∏—Ç–µ –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ –≤ Dockerfile –Ω–∞:"
            echo "      FROM ghcr.io/trenutoo/pterodactyl-images:java_21_dragonwell"
            exit 1
        fi
    fi
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è sw_linux_64
if [ -f "./sw_linux_64" ]; then
    echo ""
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è sw_linux_64:"
    if command -v ldd &> /dev/null; then
        ldd ./sw_linux_64 2>&1 | grep -E "(ssl|crypto|not found)"
    else
        echo "‚ö†Ô∏è ldd –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    fi
fi

echo ""
echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
echo "==============================================="

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if [ -f "./sw_linux_64" ]; then
    chmod +x ./sw_linux_64 2>/dev/null || true
    exec ./sw_linux_64
else
    echo "‚ùå –§–∞–π–ª sw_linux_64 –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏!"
    echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
    ls -la
    echo ""
    echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª sw_linux_64 –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Å–µ—Ä–≤–µ—Ä"
    exit 1
fi
